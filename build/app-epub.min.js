/*! app-epub 2015-04-29 */
function tab(a,b,c,d){var e=function(a){return document.getElementById(a)},f=a.split(b||"_");if(4==f.length&&(this.event=d||"onclick",a=e(a))){this.ITEM=[],a.id=f[0];for(var g=a.getElementsByTagName(f[1]),h=1,i=0;i<g.length;i++)(g[i].className.indexOf(f[2])>=0||g[i].className.indexOf(f[3])>=0)&&(g[i].className==f[2]&&(a.cur=g[i]),g[i].callBack=c||function(){},g[i].css=f,g[i].link=a,this.ITEM[h]=g[i],g[i].Index=h++,g[i][this.event]=this.ACTIVE);return a}}function wheelPage(a){a.wheelDelta>0?book.prevPage():book.nextPage()}function getstyle(a,b){return a.currentStyle?a.currentStyle[b]:getComputedStyle(a,!1)[b]}function startrun(a,b,c,d){clearInterval(a.timer),a.timer=setInterval(function(){var e=0;e="opacity"==b?Math.round(100*parseFloat(getstyle(a,b))):parseInt(getstyle(a,b));var f=(c-e)/8;f=f>0?Math.ceil(f):Math.floor(f),e==c?(clearInterval(a.timer),d&&d()):"opacity"==b?(a.style.filter="alpha(opacity="+(e+f)+")",a.style.opacity=(e+f)/100):a.style[b]=e+f+"px"},30)}function cancelFullScreen(a){var b=a.cancelFullScreen||a.webkitCancelFullScreen||a.mozCancelFullScreen||a.msExitFullscreen;if(b)b.call(a);else if("undefined"!=typeof window.ActiveXObject){var c=new ActiveXObject("WScript.Shell");null!==c&&c.SendKeys("{F11}")}}function requestFullScreen(a){var b=a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen||a.msRequestFullscreen;if(b)b.call(a);else if("undefined"!=typeof window.ActiveXObject){var c=new ActiveXObject("WScript.Shell");null!==c&&c.SendKeys("{F11}")}return!1}function Rect(a,b,c,d,e,f){this.fontFamily=a,this.fontSize=b,this.px=c,this.py=d,this.width=e,this.height=f}function Glyph(a,b){this.txt=a,this.rect=b,this.type="text"}function imageNode(a,b,c,d,e){this.src=a,this.x=b,this.y=c,this.h=d,this.w=e,this.type="image"}var EPUB=EPUB||{};EPUB.App={},RSVP.on("error",function(a){console.log(a)}),function(a){a.ePub=function(a,b,c,d){EPUB.USERID=b,EPUB.BOOKID=c,EPUB.AUTHTOKEN=d;var e=new EPUB.Book(a),f=document.getElementById("prev"),g=document.getElementById("next");return f.addEventListener("click",function(){e.prevPage()}),g.addEventListener("click",function(){e.nextPage()}),e}}(window),tab.prototype={ACTIVE:function(){var a=function(a){return document.getElementById(a)};this.link.cur.className=this.css[3],this.className=this.css[2];try{a(this.link.id+"_"+this.link.cur.Index).style.display="none",a(this.link.id+"_"+this.Index).style.display="block"}catch(b){}this.callBack.call(this),this.link.cur=this}},new tab("test2_li_now_");var width=getComputedStyle(document.getElementsByClassName("menubox")[0]).width.slice(0,-2);EPUB.SHOWMENU=!0;var btnMenu=document.getElementById("btnMenu"),menubox=document.getElementsByClassName("menubox")[0];document.addEventListener("mousewheel",wheelPage,!1),btnMenu.addEventListener("click",function(){document.getElementById("menubox_bg").style.display="none"==document.getElementById("menubox_bg").style.display?"":"none",document.getElementsByClassName("menubox")[0].style.display="",EPUB.SHOWMENU?(startrun(menubox,"right",0,function(){startrun(menubox,"opacity","100")}),document.removeEventListener("mousewheel",wheelPage,!1),EPUB.SHOWMENU=!1):(document.addEventListener("mousewheel",wheelPage,!1),startrun(menubox,"right",-width,function(){startrun(menubox,"opacity","100")}),EPUB.SHOWMENU=!0)});var iconZoom=document.getElementById("iconZoom");iconZoom.addEventListener("click",function(){var a=document.body,b=document.msFullscreenElement&&null!==document.msFullscreenElement||document.mozFullScreen||document.webkitIsFullScreen;return b?(cancelFullScreen(document),iconZoom.setAttribute("class","icon-gernal icon_zoom")):(requestFullScreen(a),iconZoom.setAttribute("class","icon-gernal icon_zoomout")),!1}),EPUB.VERSION="1.0.0",EPUB.LINEGAP=15,EPUB.ELEMENTS={p:{fontSize:18,fontFamily:"Monospace, 'Microsoft Yahei', 微软雅黑, STHeiti, Hei,'Heiti SC',黑体"},a:{fontSize:18,fontFamily:"Monospace, 'Microsoft Yahei', 微软雅黑, STHeiti, Hei,'Heiti SC',黑体"},span:{fontSize:18,fontFamily:"Monospace, 'Microsoft Yahei', 微软雅黑, STHeiti, Hei,'Heiti SC',黑体"},h1:{fontSize:22,fontFamily:"Monospace, 'Microsoft Yahei', 微软雅黑, STHeiti, Hei,'Heiti SC',黑体"},h2:{fontSize:20,fontFamily:"Monospace, 'Microsoft Yahei', 微软雅黑, STHeiti, Hei,'Heiti SC',黑体"},h3:{fontSize:18,fontFamily:"Monospace, 'Microsoft Yahei', 微软雅黑, STHeiti, Hei,'Heiti SC',黑体"},img:{fontSize:0,fontFamily:"Monospace, 'Microsoft Yahei', 微软雅黑, STHeiti, Hei,'Heiti SC',黑体"}},EPUB.USERID="",EPUB.BOOKID="",EPUB.AUTHTOKEN="",EPUB.Book=function(a){this.el=this.getEl(a),this.render=new EPUB.Render(this),this.events=new EPUB.Events(this,this.el),this.format=new EPUB.Format(this),this.beforeDisplay()},EPUB.Book.prototype.getEl=function(a){return document.getElementById(a)},EPUB.Book.prototype.beforeDisplay=function(){var a=this;a.getBook(EPUB.USERID,EPUB.BOOKID,EPUB.AUTHTOKEN).then(function(b){return a.bookUrl=EPUB.Utils.parseUrl(b).directory,a.loadOpfFile(a.bookUrl)}).then(function(b){var c=a.format.formatOpfFile(b);a.manifest=c.manifest,a.spine=c.spine}).then(function(){return a.getProgress()}).then(function(){return a.getNotes()}).then(function(){return a.getMarks()}).then(function(){return a.display()}).then(function(b){return a.initialChapter(b)}).then(function(){window.addEventListener("resize",function(){a.initialChapter(a.renderContext).then(function(){var b=a.render.calculateDisplayNum(a.render.position);a.render.display(b)})}),window.onbeforeunload=function(b){var c="离开此页将关闭浏览器，你的阅读进度将自动保存";return"undefined"==typeof b&&(b=window.event),b&&(b.returnValue=c,a.saveProgress()),c};var b=a.render.calculateDisplayNum(a.render.position);a.render.display(b)})},EPUB.Book.prototype.getBook=function(a,b,c){var d={user_id:a,book_id:b,auth_token:c},e=new RSVP.defer;return EPUB.Request.bookStoreRequest("/retech-bookstore/mobile/post/get_epub_info",d).then(function(a){e.resolve(a.path)}),e.promise},EPUB.Book.prototype.display=function(a,b){var c=this,d=new RSVP.defer;this.spineNum=b||this.spineNum;var e=a||c.manifest[c.spine[this.spineNum].id].url;return c.render.chapterUrl=e,EPUB.Request.loadFile(e,"xml").then(function(a){c.render.chapterName=c.spineNum.toString();var b=a.querySelectorAll("h1,h2,h3");b.length>0&&(c.render.chapterName=b[0].textContent);var e=document.getElementById("chapterId");e.textContent=c.render.chapterName,d.resolve(a),c.renderContext=a}),d.promise},EPUB.Book.prototype.initialChapter=function(a){var b=this,c=this.render.initialize(a).then(function(a){b.render.spineNum=b.spineNum,b.render.getPagesNum(a),b.render.notes=b.getChapterNotes(b.spineNum),b.render.marks=b.getChapterMarks(b.spineNum)});return c},EPUB.Book.prototype.loadOpfFile=function(a){var b,c=this,d=a+"META-INF/container.xml";return b=EPUB.Request.loadFile(d,"xml").then(function(a){return c.format.formatContainerXML(a)}).then(function(b){return EPUB.Request.loadFile(a+b.packagePath,"xml")})},EPUB.Book.prototype.nextPage=function(){var a,b=this;a=this.render.nextPage(),a||(this.spineNum<this.spine.length-1?(this.spineNum++,this.display().then(function(a){return b.initialChapter(a)}).then(function(){b.render.display(1)})):(b.progress="yes",alert("已经是最后一页")))},EPUB.Book.prototype.prevPage=function(){var a,b=this;a=this.render.prevPage(),a||(this.spineNum>0?(this.spineNum--,this.display().then(function(a){return b.initialChapter(a)}).then(function(){var a=b.render.pages.length;b.render.display(a)})):alert("已经是第一页"))},EPUB.Book.prototype.getTOC=function(){return this.format.toc},EPUB.Book.prototype.createToc=function(a){function b(a,d,e){var f=e,g=document.createElement("ul");g.setAttribute("class","menuconlist"),a.appendChild(g),d.forEach(function(a){var d=document.createElement("li");d.setAttribute("style","padding-left:"+f+"em"),g.appendChild(d);var e=document.createElement("a");e.addEventListener("click",function(){c.display(a.url,a.spineNum).then(function(a){return c.initialChapter(a)}).then(function(){c.render.display(1)}),document.addEventListener("mousewheel",wheelPage,!1),document.getElementById("menubox_bg").style.display="none"==document.getElementById("menubox_bg").style.display?"":"none",document.getElementsByClassName("menubox")[0].style.display="none",EPUB.SHOWMENU=!0}),e.textContent=a.label,d.appendChild(e),a.subitems.length>0&&b(g,a.subitems,f+2)})}var c=this,d=document.getElementById("test2_1");if(d.setAttribute("class","tablistx block"),d.innerHTML="",a.length>0)b(d,a,0);else{var e=document.createElement("div");e.setAttribute("class","noconbox"),d.appendChild(e);var f=document.createElement("a");f.setAttribute("class","nomenu nothings"),f.textContent="没有目录",e.appendChild(f)}},EPUB.Book.prototype.saveProgress=function(){var a={user_id:EPUB.USERID,auth_token:EPUB.AUTHTOKEN,book_id:EPUB.BOOKID,chapter_index:this.spineNum,position:this.render.position,progress:this.progress};EPUB.Request.bookStoreRequest("/retech-bookstore/mobile/post/my/readprogress/save",a)},EPUB.Book.prototype.getProgress=function(){var a=this,b="/retech-bookstore/mobile/post/my/singlebook/readprogress/get",c={user_id:EPUB.USERID,auth_token:EPUB.AUTHTOKEN,book_id:EPUB.BOOKID},d=EPUB.Request.bookStoreRequest(b,c).then(function(b){""!=b.user_readprogress?(a.spineNum=b.user_readprogress.chapter_index,a.render.position=b.user_readprogress.position,a.progress=b.user_readprogress.progress):(a.spineNum=0,a.render.position=0,a.progress="no")});return d},EPUB.Book.prototype.getNotes=function(){var a=this,b="/retech-bookstore/mobile/post/my/singlebook/note/list",c={user_id:EPUB.USERID,auth_token:EPUB.AUTHTOKEN,book_id:EPUB.BOOKID},d=EPUB.Request.bookStoreRequest(b,c).then(function(b){a.notelist=b.user_note_list,a.createNote(a.notelist)});return d},EPUB.Book.prototype.createNote=function(a){var b=this,c=document.getElementById("test2_3");if(c.innerHTML="",a.length>0){var d=document.createElement("div");c.appendChild(d);var e=document.createElement("p");e.setAttribute("class","recordp"),e.textContent="条记录",d.appendChild(e);var f=document.createElement("span");f.setAttribute("class","redcolor"),e.insertBefore(f,e.firstChild),f.textContent=a.length,a.forEach(function(a){var d=document.createElement("div");d.setAttribute("class","coninfbox"),c.appendChild(d);var e=document.createElement("span");e.setAttribute("class","browcolor"),e.textContent=a.add_time,d.appendChild(e);var f=document.createElement("p");f.setAttribute("class","coninfop"),f.textContent=a.summary_content,f.addEventListener("click",function(c){b.display("",a.chapter_index).then(function(a){return b.initialChapter(a)}).then(function(){var c=b.render.calculateDisplayNum(parseInt(a.position.split(",")[0]));b.render.display(c)}),document.addEventListener("mousewheel",wheelPage,!1),document.getElementById("menubox_bg").style.display="none"==document.getElementById("menubox_bg").style.display?"":"none",document.getElementsByClassName("menubox")[0].style.display="none",EPUB.SHOWMENU=!0}),d.appendChild(f);var g=document.createElement("span");g.setAttribute("class","browcolor"),g.textContent=a.note_content,d.appendChild(g);var h=document.createElement("span");h.setAttribute("class","redcolor"),h.textContent="注：",g.insertBefore(h,g.firstChild)})}else{var g=document.createElement("div");g.setAttribute("class","noconbox"),c.appendChild(g);var h=document.createElement("a");h.setAttribute("class","nonote nothings"),h.textContent="没有笔记",g.appendChild(h);var i=document.createElement("p");i.setAttribute("class","nothingp"),i.textContent="在阅读时长按以选中文字添加笔记",g.appendChild(i)}},EPUB.Book.prototype.getMarks=function(){var a=this,b="/retech-bookstore/mobile/post/my/singlebook/bookmark/list",c={user_id:EPUB.USERID,book_id:EPUB.BOOKID,auth_token:EPUB.AUTHTOKEN},d=EPUB.Request.bookStoreRequest(b,c).then(function(b){a.markList=b.user_bookmark_list,a.createMark(a.markList)});return d},EPUB.Book.prototype.createMark=function(a){var b=this,c=document.getElementById("test2_2");if(c.innerHTML="",a.length>0){var d=document.createElement("div");c.appendChild(d);var e=document.createElement("p");e.setAttribute("class","recordp"),e.textContent="条记录",d.appendChild(e);var f=document.createElement("span");f.setAttribute("class","redcolor"),f.textContent=a.length,e.insertBefore(f,e.firstChild),a.forEach(function(a){var c=document.createElement("div");c.setAttribute("class","coninfbox"),d.appendChild(c);var e=document.createElement("span");e.setAttribute("class","browcolor"),e.textContent=a.add_time,c.appendChild(e);var f=document.createElement("p");f.setAttribute("class","coninfop"),f.textContent=a.summary_content,f.addEventListener("click",function(){b.display("",a.chapter_index).then(function(a){return b.initialChapter(a)}).then(function(){var c=b.render.calculateDisplayNum(parseInt(a.position));b.render.display(c)}),document.addEventListener("mousewheel",wheelPage,!1),document.getElementById("menubox_bg").style.display="none"==document.getElementById("menubox_bg").style.display?"":"none",document.getElementsByClassName("menubox")[0].style.display="none",EPUB.SHOWMENU=!0}),c.appendChild(f)})}else{var g=document.createElement("div");g.setAttribute("class","noconbox"),c.appendChild(g);var h=document.createElement("a");h.setAttribute("class","notag nothings"),h.textContent="暂时没有书签",g.appendChild(h);var i=document.createElement("p");i.setAttribute("class","nothingp"),i.textContent="在阅读时点击屏幕右上角可添加书签",g.appendChild(i)}},EPUB.Book.prototype.getChapterNotes=function(a){var b=[];return this.notelist.forEach(function(c){c.chapter_index==a&&b.push(c)}),b},EPUB.Book.prototype.getChapterMarks=function(a){var b=[];return this.markList.forEach(function(c){c.chapter_index==a&&b.push(c)}),b},EPUB.Events=function(a,b){return this.events={},b?this.el=b:this.el=document.createElement("div"),a.createEvent=this.createEvent,a.tell=this.tell,a.listen=this.listen,a.deafen=this.deafen,this},EPUB.Events.prototype.createEvent=function(a){var b=new CustomEvent(a);return this.events[a]=b,b},EPUB.Events.prototype.tell=function(a,b){var c;this.events[a]?c=this.events[a]:(console.warn("No event: ",a,"defined yet, creating."),c=this.createEvent(a)),b&&(c.msg=b),this.el.dispatchEvent(c)},EPUB.Events.prototype.listen=function(a,b,c){return this.events[a]?void(c?this.el.addEventListener(a,b.bind(c),!1):this.el.addEventListener(a,b,!1)):(console.warn("No event: ",a,"defined yet, creating"),void this.createEvent(a))},EPUB.Events.prototype.deafen=function(a,b){this.el.removeEventListener(a,b,!1)},EPUB.Format=function(a){this.book=a},EPUB.Format.prototype.formatContainerXML=function(a){this.baseUrl=this.book.bookUrl||"";var b,c,d;return b=a.querySelector("rootfile"),c=b.getAttribute("full-path"),this.bookUrl=this.baseUrl+EPUB.Utils.parseUrl(c).base,d=a.xmlEncoding,{packagePath:c,encoding:d,bookUrl:this.bookUrl}},EPUB.Format.prototype.formatOpfFile=function(a){var b,c,d,e,f,g,h=this;return b=a.querySelector("metadata"),c=a.querySelector("manifest"),d=a.querySelector("spine"),e=this.formatMetadata(b),f=this.formatManifest(c),g=this.formatSpine(d,f),g.forEach(function(a){h.spineIndex[a.href]=a.index}),{metadata:e,manifest:f,spine:g}},EPUB.Format.prototype.formatMetadata=function(a){var b={};return b.bookTitle=this.getXMLTextByTag(a,"title"),b.creator=this.getXMLTextByTag(a,"creator"),b.description=this.getXMLTextByTag(a,"description"),b.pubdate=this.getXMLTextByTag(a,"pubdate"),b.publisher=this.getXMLTextByTag(a,"publisher"),b.identifier=this.getXMLTextByTag(a,"identifier"),b.language=this.getXMLTextByTag(a,"language"),b.rights=this.getXMLTextByTag(a,"rights"),b},EPUB.Format.prototype.getXMLTextByTag=function(a,b){var c,d=a.getElementsByTagNameNS("http://purl.org/dc/elements/1.1/",b);return d&&0!==d.length?(c=d[0],c.childNodes.length?c.childNodes[0].nodeValue:""):""},EPUB.Format.prototype.formatManifest=function(a){var b={},c=this,d=a.querySelectorAll("item"),e=Array.prototype.slice.call(d);return e.forEach(function(a){var d=a.getAttribute("id"),e=a.getAttribute("href")||"",f=a.getAttribute("media-type")||"",g=a.getAttribute("properties")||"";b[d]={href:e,url:c.bookUrl+e,type:f,properties:g},"application/x-dtbncx+xml"==a.getAttribute("media-type")&&c.formatToc(e)}),b},EPUB.Format.prototype.formatSpine=function(a,b){var c=[];this.spineIndex={};var d=a.getElementsByTagName("itemref"),e=Array.prototype.slice.call(d);return e.forEach(function(a,d){var e=a.getAttribute("idref"),f=a.getAttribute("properties")||"",g=a.getAttribute("linear")||"",h={id:e,properties:f,linear:g,href:b[e].href,url:b[e].url,index:d};c.push(h)}),c},EPUB.Format.prototype.formatToc=function(a){var b=this,c=this.bookUrl+a;this.toc=[],EPUB.Request.loadFile(c,"xml").then(function(a){function c(a,d){var e=[],f=Array.prototype.slice.call(a);return f.forEach(function(a){var f=a.getAttribute("id"),g=a.getElementsByTagName("content")[0],h=g.getAttribute("src"),i=b.bookUrl+h,j=(a.getElementsByTagName("navLabel")[0],a.getElementsByTagName("navLabel")[0].textContent?a.getElementsByTagName("navLabel")[0].textContent:""),k=a.getElementsByTagName("navPoint")||!1,l=!1,m=a.parentNode==d;m&&(k&&(l=c(k,a)),e.push({id:f,href:h,label:j,url:i,spineNum:parseInt(b.spineIndex[h]),subitems:l}))}),e}var d=a.getElementsByTagName("navMap")[0];b.toc=c(d.getElementsByTagName("navPoint"),d),b.book.createToc(b.book.getTOC())})},EPUB.Notation=function(a){this.render=a.render,this.pages=[],this.svg=[],this.svgSelected=[],this.bacRects=[],this.showPostion={},this.string="",this.initialDialog()},EPUB.Notation.prototype.show=function(a,b){var c=this,d=Array.prototype.slice.call(this.node.querySelectorAll("a[search]"));d.forEach(function(a){"ujs_search_link_go"==a.className&&(a.href=c.string)}),this.node.style.display="block";var e=this.node.offsetWidth,f=this.node.offsetHeight,g=window.scrollX,h=window.scrollY,i=window.innerWidth,j=window.innerHeight,k=g+i-e,l=h+j-f;a=a+10>k?k:g>a+10?g:a+10,b=b>l?l:h>b?h:b,this.node.style.left=a+"px",this.node.style.top=b+"px"},EPUB.Notation.prototype.showHasDel=function(a,b){var c=this,d=Array.prototype.slice.call(this.node.querySelectorAll("a[search]"));d.forEach(function(a){"ujs_search_link_go"==a.className&&(a.href=c.string)}),this.nodeHasDel.style.display="block";var e=this.nodeHasDel.offsetWidth,f=this.nodeHasDel.offsetHeight,g=window.scrollX,h=window.scrollY,i=window.innerWidth,j=window.innerHeight,k=g+i-e,l=h+j-f;a=a+10>k?k:g>a+10?g:a+10,b=b>l?l:h>b?h:b,this.nodeHasDel.style.left=a+"px",this.nodeHasDel.style.top=b+"px"},EPUB.Notation.prototype.hideHasNote=function(){this.node.style.left="0px",this.node.style.top="0px",this.node.style.display="none"},EPUB.Notation.prototype.hideHasDel=function(){this.nodeHasDel.style.left="0px",this.nodeHasDel.style.top="0px",this.nodeHasDel.style.display="none"},EPUB.Notation.prototype.initialDialog=function(){var a=this;this.node=document.getElementById("noteSearch"),this.node.addEventListener("click",function(b){b.stopPropagation(),a.hideHasNote()},!1),this.nodeHasDel=document.getElementById("delSearch"),this.nodeHasDel.addEventListener("click",function(){a.hideHasDel()});var b=document.getElementById("del-note");b.addEventListener("click",function(c){var d=b.getAttribute("data-noteid");d&&a.deletNotation(d)}),this.dialogNode=document.getElementsByClassName("pup_con")[0];var c=this.dialogNode.getElementsByTagName("img")[0];c.addEventListener("click",function(){a.hideDialog()});var d=document.getElementById("noteSave");d.addEventListener("click",function(){a.getString(a.svgSelected).length>255?alert("选择内容过大"):document.getElementById("comment-content").value.length>255?alert("笔记内容过大"):a.sendNotation()}),this.textNode=document.getElementById("note"),this.markNode=document.getElementById("markNode"),this.markNode.addEventListener("click",function(){var b=a.markNode.getAttribute("data-markid");b?a.deleteMark(b):a.saveMark()}),this.shareNode=document.getElementById("shareNode"),this.shareNode.addEventListener("click",function(){a.hideShareNode()})},EPUB.Notation.prototype.initNotation=function(){var a=this;if(this.svgSelected.length>0){this.show(this.showPostion.x,this.showPostion.y);var b=this.getString(a.svgSelected),c=document.getElementById("copy-button");c.setAttribute("data-clipboard-text",b);{new ZeroClipboard(c)}window.jiathis_config.summary=b;var d=document.getElementById("share");d.addEventListener("click",function(b){a.showShareNode(b.pageX,b.pageY)});var e=document.getElementById("show-dialog");e.addEventListener("click",function(){a.showDialog()})}else this.hideHasNote(),this.hideHasDel(),this.hideShareNode(),this.hideText()},EPUB.Notation.prototype.getString=function(a){var b="";if(a.length>0){var c=Array.prototype.slice.call(a);c.forEach(function(a){b+=a.textContent})}return b},EPUB.Notation.prototype.showText=function(a,b,c){this.textNode.getElementsByTagName("p")[0].textContent=c;var d=EPUB.Utils.getCss(this.textNode,"height").slice(0,-2);b+parseInt(d)>this.render.height?b-=d:b,this.textNode.style.left=a+"px",this.textNode.style.top=b+"px",this.textNode.style.display="block"},EPUB.Notation.prototype.showDialog=function(){this.dialogNode.getElementsByClassName("pup_hight")[0].textContent=this.getString(this.svgSelected),document.getElementById("back").setAttribute("class","pup_bg"),this.dialogNode.style.display="block"},EPUB.Notation.prototype.hideText=function(){this.textNode.style.left="0px",this.textNode.style.top="0px",this.textNode.style.display="none"},EPUB.Notation.prototype.hideDialog=function(){document.getElementById("back").removeAttribute("class"),document.getElementById("comment-content").value="留下你的笔记",this.dialogNode.style.display="none"},EPUB.Notation.prototype.showShareNode=function(a,b){this.shareNode.style.left=a+"px",this.shareNode.style.top=b+"px",this.shareNode.style.display="block"},EPUB.Notation.prototype.hideShareNode=function(){this.shareNode.style.left="0px",this.shareNode.style.top="0px",this.shareNode.style.display="none"},EPUB.Notation.prototype.deletNotation=function(a){var b=this,c={id:a,user_id:EPUB.USERID,auth_token:EPUB.AUTHTOKEN},d=new RSVP.defer;return EPUB.Request.bookStoreRequest("/retech-bookstore/mobile/post/my/note/delete",c).then(function(c){if("1"==c.flag){var e=document.getElementsByClassName(a),f=Array.prototype.slice.call(e);f.forEach(function(a){b.svg.removeChild(a)});var g=b.svg.getElementById(a),h=Array.prototype.slice.call(g.childNodes);h.forEach(function(a){b.svg.insertBefore(a,g)}),b.svg.removeChild(g),b.render.book.getNotes().then(function(){b.render.notes=b.render.book.getChapterNotes(b.render.book.spineNum)}),d.resolve(!0)}d.resolve(!1)}),d.promise},EPUB.Notation.prototype.delSelectedNotation=function(a){var b=new RSVP.defer,c=this,d=a.length;return a.length>0&&a.forEach(function(a){c.deletNotation(a).then(function(){d--}),0==d&&b.resolve(!0)}),b.resolve(!0),b.promise},EPUB.Notation.prototype.sendNotation=function(){var a,b=this,c={user_id:EPUB.USERID,auth_token:EPUB.AUTHTOKEN,book_id:EPUB.BOOKID,chapter_index:b.render.spineNum,chapter_name:b.render.chapterName,position:b.selectedOffset().startOffset+","+b.selectedOffset().endOffset,position_offset:b.selectedOffset().startOffset+","+b.svgSelected.length,summary_content:b.getString(b.svgSelected),note_content:document.getElementById("comment-content").value,summary_underline_color:"red",add_time:(new Date).Format("yyyy-MM-dd hh:mm:ss"),process:b.render.book.progress},d=[];this.svgSelected.forEach(function(b){"g"==b.parentNode.tagName&&(a=b.parentNode.getAttribute("id"),-1==d.indexOf(a)&&d.push(a))}),b.delSelectedNotation(d).then(function(){return EPUB.Request.bookStoreRequest("/retech-bookstore/mobile/post/my/note/save",c)}).then(function(a){"1"==a.flag&&(b.createUnderline(a.note_id),b.createTextCircle(a.note_id,document.getElementById("comment-content").value),b.render.book.getNotes().then(function(){b.render.notes=b.render.book.getChapterNotes(b.render.book.spineNum)}))}),b.bacRects.forEach(function(a){b.svg.removeChild(a)}),b.bacRects.length=0,b.hideDialog()},EPUB.Notation.prototype.saveMark=function(){var a=this,b=this.render.position,c=a.getString(a.svg.childNodes).slice(0,100),d={user_id:EPUB.USERID,auth_token:EPUB.AUTHTOKEN,book_id:EPUB.BOOKID,chapter_index:a.render.spineNum,chapter_name:a.render.chapterName,position:b,add_time:(new Date).Format("yyyy-MM-dd hh:mm:ss"),summary_content:c};EPUB.Request.bookStoreRequest("/retech-bookstore/mobile/post/my/bookmark/add",d).then(function(b){"1"==b.flag&&(a.markNode.setAttribute("class","icon-gernal clicktag"),a.markNode.setAttribute("data-markid",b.bookmark_id),a.render.book.getMarks().then(function(){a.render.marks=a.render.book.getChapterMarks(a.render.book.spineNum)}))})},EPUB.Notation.prototype.deleteMark=function(a){var b=this,c={user_id:EPUB.USERID,auth_token:EPUB.AUTHTOKEN,id:a};EPUB.Request.bookStoreRequest("/retech-bookstore/mobile/post/my/bookmark/delete",c).then(function(a){"1"==a.flag&&(b.markNode.setAttribute("class","icon-gernal icon-tag"),b.markNode.setAttribute("data-markid",""),b.render.book.getMarks().then(function(){b.render.marks=b.render.book.getChapterMarks(b.render.book.spineNum)}))})},EPUB.Notation.prototype.createUnderline=function(a){var b=this,c=document.createElementNS("http://www.w3.org/2000/svg","g");c.setAttribute("id",a),b.svg.insertBefore(c,b.svgSelected[0]),b.svgSelected.forEach(function(c){if("image"!=c.tagName){var d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("x",c.getAttribute("x")),d.setAttribute("y",c.getAttribute("y")),d.setAttribute("width",c.getAttribute("data-width")),d.setAttribute("height","2"),d.setAttribute("fill","red"),d.setAttribute("class",a),d.addEventListener("click",function(a){b.show(a.pageX,a.pageY)}),b.svg.appendChild(d)}}),b.svgSelected.forEach(function(a){c.appendChild(a)}),c.addEventListener("click",function(c){var d=c.target.parentNode,e=b.getString(d.childNodes);window.jiathis_config.summary=e;var f=document.getElementById("shared");f.addEventListener("click",function(a){b.showShareNode(a.pageX,a.pageY)});var g=document.getElementById("copied-button");g.setAttribute("data-clipboard-text",e);var h=(new ZeroClipboard(g),document.getElementById("del-note"));h.setAttribute("data-noteid",a),b.showHasDel(c.pageX,c.pageY)})},EPUB.Notation.prototype.createTextCircle=function(a,b){var c=this,d=c.svgSelected[c.svgSelected.length-1],e=parseInt(d.getAttribute("x"),10)+parseInt(d.getAttribute("data-width"),10),f=parseInt(d.getAttribute("y"),10),g=document.createElementNS("http://www.w3.org/2000/svg","circle");g.setAttribute("cx",e),g.setAttribute("cy",f),g.setAttribute("r","5"),g.setAttribute("fill","red"),g.setAttribute("class",a),g.addEventListener("click",function(a){c.showText(a.pageX,a.pageY,b)}),c.svg.appendChild(g),c.bacRects.length=0},EPUB.Notation.prototype.selectedOffset=function(){var a=this.render.position,b=0,c=Array.prototype.slice.call(document.getElementsByClassName("context"));return a+=c.indexOf(this.svgSelected[0]),b=a+this.svgSelected.length,{startOffset:a,endOffset:b}},EPUB.Notation.prototype.showNotation=function(){var a=this;if(a.render.notes.length>0){var b=0,c=0;c=this.render.position;for(var d=0;d<this.pages[this.pageIndex-1].length;d++)b+=this.pages[this.pageIndex-1][d].length;b+=c,a.render.notes.forEach(function(d){var e,f,g,h=d.position.split(",")[0],i=d.position.split(",")[1];c>h&&i>c&&b>=i?(e=0,f=i-c,g=Array.prototype.slice.call(document.getElementsByClassName("context")),a.svgSelected=g.slice(e,f),a.createUnderline(d.id),a.createTextCircle(d.id,d.note_content)):h>=c&&b>=i?(e=h-c,f=i-c,g=Array.prototype.slice.call(document.getElementsByClassName("context")),a.svgSelected=g.slice(e,f),a.createUnderline(d.id),a.createTextCircle(d.id,d.note_content)):h>=c&&i>b&&(e=h-c,f=b-c,g=Array.prototype.slice.call(document.getElementsByClassName("context")),a.svgSelected=g.slice(e,f),a.createUnderline(d.id))})}},EPUB.Notation.prototype.showMark=function(){var a=this,b="";if(a.render.marks.length>0){var c=0,d=0;d=this.render.position;for(var e=0;e<this.pages[this.pageIndex-1].length;e++)c+=this.pages[this.pageIndex-1][e].length;c+=d,a.render.marks.forEach(function(a){a.position>=d&&a.position<c&&(b=a)})}b?(a.markNode.setAttribute("class","icon-gernal clicktag"),a.markNode.setAttribute("data-markid",b.id)):(a.markNode.setAttribute("class","icon-gernal icon-tag"),a.markNode.setAttribute("data-markid",""))},EPUB.Paragraph=function(){},EPUB.Paragraph.prototype.isDbcCase=function(a){return a>=32&&127>=a||a>=65377&&65439>=a?!0:!1},EPUB.Paragraph.prototype.isSpace=function(a){return 32==a?!0:!1},EPUB.Paragraph.prototype.isEnglish=function(a){return a>=65&&90>=a||a>=97&&122>=a?!0:!1},EPUB.Paragraph.prototype.isPunctuation=function(a){return a>=33&&47>=a||a>=58&&63>=a?!0:!1},EPUB.Paragraph.prototype.isChinese=function(a){return a>=1e4?!0:!1},EPUB.Render=function(a){this.position=0,this.book=a,this.el=this.book.el,this.paragraph=new EPUB.Paragraph,this.lineGap=EPUB.LINEGAP,this.selections=new EPUB.Selections(this)},EPUB.Render.prototype.initialize=function(a){this.width=this.el.clientWidth,this.height=this.el.clientHeight-60,this.imagesAll={};var b=this,c=new RSVP.defer,d=a.getElementsByTagName("body")[0];this.displayedPage=1,this.currentPositionY=12,this.currentPositionX=0,this.currentLine=new Array,this.currentPage=new Array,this.pages=new Array,this.currentPage.push(this.currentLine),this.pages.push(this.currentPage);var e=a.querySelectorAll("img");if(e.length>0){var f=Array.prototype.slice.call(e),g=f.length;f.forEach(function(a){var e=new Image,f=EPUB.Utils.parseUrl(b.chapterUrl),h=EPUB.Utils.parseUrl(a.getAttribute("src"));e.onload=function(){g--,b.imagesAll.hasOwnProperty(h.filename)||(b.imagesAll[h.filename]={src:f.directory+a.getAttribute("src"),height:e.height,width:e.width}),0==g&&c.resolve(d)},e.src=f.directory+a.getAttribute("src")})}else c.resolve(d);return c.promise},EPUB.Render.prototype.getPagesNum=function(a){return this.getAllTextNodeContextAndRender(a),this.displayedPages=this.pages.length,this.displayedPages},EPUB.Render.prototype.getAllTextNodeContextAndRender=function(a){for(var b=a.childNodes,c=0;c<b.length;c++){var d=b[c],e=d.nodeType;EPUB.ELEMENTS.hasOwnProperty(d.nodeName)&&"span"!=d.nodeName&&(this.currentPositionY+=EPUB.ELEMENTS[d.nodeName].fontSize+this.lineGap,this.currentPositionX=2*EPUB.ELEMENTS[d.nodeName].fontSize,this.currentLine=new Array,this.currentPage.push(this.currentLine),"img"==d.nodeName&&(this.currentPositionY-=this.lineGap/2,this.imageSetting(d))),3!=e||/^\s+$/.test(d.nodeValue)?(1==e||9==e||11==e)&&this.getAllTextNodeContextAndRender(d):this.typeSetting(d)}this.displayedPages=this.pages.length},EPUB.Render.prototype.imageSetting=function(a){var b,c=EPUB.Utils.parseUrl(a.getAttribute("src")),d=this.imagesAll[c.filename],e=d.height/(this.height-this.currentPositionY-2*this.lineGap),f=d.width/this.width,g=Math.max(e,f),h=0,i=0,j=0;g>1&&5>e?(h=d.height/g,i=d.width/g,i<this.width&&(j=(this.width-i)/2),b=new imageNode(d.src,j,this.currentPositionY,h,i),this.currentLine.push(b),this.currentLine=new Array,this.currentPage.push(this.currentLine),this.currentPositionY+=h+1.5*this.lineGap):e>5?(e=d.height/this.height,f=d.width/this.width,g=Math.max(e,f),h=d.height/g,i=d.width/g,i<this.width&&(j=(this.width-i)/2),this.currentLine=new Array,b=new imageNode(d.src,j,12,h,i),this.currentLine.push(b),this.currentPage=new Array,this.currentPage.push(this.currentLine),this.pages.push(this.currentPage),this.currentPositionY+=h):(h=d.height,i=d.width,i<this.width&&(j=(this.width-i)/2),b=new imageNode(d.src,j,this.currentPositionY,h,i),this.currentLine.push(b),this.currentLine=new Array,this.currentPage.push(this.currentLine),this.currentPositionY+=h+1.5*this.lineGap)},EPUB.Render.prototype.typeSetting=function(a){for(var b=a.textContent,c=EPUB.ELEMENTS[a.parentNode.tagName]||EPUB.ELEMENTS.p,d=0;d<b.length;d++){var e,f,g,h=b.charAt(d),i=b.charCodeAt(d);this.changeLineOrPage(this.width,this.height,c,i),this.paragraph.isDbcCase(i)&&this.paragraph.isSpace(i)&&0==this.currentPositionX?e=new Rect(c.fontFamily,c.fontSize,this.currentPositionX,this.currentPositionY,0,c.fontSize):(g=this.getXOffsetByCharCode(c,i),e=new Rect(c.fontFamily,c.fontSize,this.currentPositionX,this.currentPositionY,g,c.fontSize),
this.currentPositionX+=g),f=new Glyph(h,e),this.currentLine.push(f)}},EPUB.Render.prototype.changeLineOrPage=function(a,b,c,d){var e=c.fontSize;this.currentPositionX+e>a&&(this.paragraph.isPunctuation(d)||this.paragraph.isEnglish(d))||this.currentPositionX+e>a&&(this.currentPositionX>=a&&this.reSettingLine(a),this.currentPositionY+=c.fontSize+this.lineGap,this.currentPositionX=0,this.currentLine=new Array,this.currentPage.push(this.currentLine)),this.currentPositionY+c.fontSize+this.lineGap>b&&(this.currentPositionY=c.fontSize,this.currentLine=new Array,this.currentPage=new Array,this.currentPage.push(this.currentLine),this.pages.push(this.currentPage))},EPUB.Render.prototype.reSettingLine=function(a){for(var b,c=this.currentLine.length,d=0,e=0,f=0;c>f;f++)b=this.currentLine[f],"text"==b.type&&(this.paragraph.isDbcCase(b.txt.charCodeAt(0))?d++:e+=b.rect.width);for(var g=this.currentLine[0].rect.px,h=(a-e-g)/d,i=0,c=this.currentLine.length;c>i;i++)0==i&&this.paragraph.isSpace(this.currentLine[0].txt.charCodeAt(0))||(b=this.currentLine[i],b.rect.px=g,this.paragraph.isDbcCase(b.txt.charCodeAt(0))?(b.rect.width=h,g+=h):g+=b.rect.width)},EPUB.Render.prototype.display=function(a){this.el.innerHTML="",this.displayedPage=a,this.position=this.getPosition(a);for(var b=this.pages[this.displayedPage-1],c='<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="'+this.width+'" height="'+this.height+'">',d=0;d<b.length;d++)for(var e=0;e<b[d].length;e++){var f=b[d][e];"text"==f.type?c+='<text class="context"  font-family="'+f.rect.fontFamily+"\" font-size='"+f.rect.fontSize+"' data-width = '"+f.rect.width+"' data-height = '"+f.rect.height+"' x='"+f.rect.px+"' y='"+f.rect.py+"'>"+f.txt+"</text>":"image"==f.type&&(c+='<image class="context" xlink:href=\''+f.src+"' x='"+f.x+"' y='"+f.y+"'  height='"+f.h+"' width='"+f.w+"' data-height = '"+f.h+"'/>")}c+="</svg>",this.el.innerHTML=c,this.selections.initSelection()},EPUB.Render.prototype.getPosition=function(a){for(var b=0,c=0;a-1>c;c++)for(var d=0;d<this.pages[c].length;d++)b+=this.pages[c][d].length;return b},EPUB.Render.prototype.calculateDisplayNum=function(a){for(var b=0,c=0,d=this.pages.length;d>c;c++)for(var e=0,f=this.pages[c].length;f>e;e++)if(b+=this.pages[c][e].length,b>a)return c+1},EPUB.Render.prototype.getXOffsetByCharCode=function(a,b){var c=0;return c=this.paragraph.isDbcCase(b)?a.fontSize/2+3:a.fontSize},EPUB.Render.prototype.nextPage=function(){return this.displayedPage<this.displayedPages?(this.displayedPage++,this.display(this.displayedPage),!0):!1},EPUB.Render.prototype.prevPage=function(){return this.displayedPage>1?(this.displayedPage--,this.display(this.displayedPage),!0):!1};var EPUB=EPUB||{};EPUB.Request={},EPUB.Request.loadFile=function(a,b){function c(){if(this.readyState===this.DONE&&(200===this.status||this.responseXML)){var a;a="xml"==b?(new DOMParser).parseFromString(this.responseText,"text/xml"):"json"==b?JSON.parse(this.responseText):this.responseText,d.resolve(a)}}var d=new RSVP.defer,e=new XMLHttpRequest;return e.open("GET",a,!0),e.onreadystatechange=c,"json"==b&&e.setRequestHeader("Accept","application/json"),e.send(),d.promise},EPUB.Request.bookStoreRequest=function(a,b){function c(){if(4===this.readyState){var a=JSON.parse(this.responseText);d.resolve(a)}}var d=new RSVP.defer,e=new XMLHttpRequest;return e.open("POST",a),e.onreadystatechange=c,e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.send(EPUB.Utils.JsonToFormData(b)),d.promise},EPUB.Selections=function(a){this.render=a,this.notation=new EPUB.Notation(this)},EPUB.Selections.prototype.initSelection=function(){function a(a){b.endXY={x:a.pageX,y:a.pageY},b.unChangeXY.y>b.endXY.y?(b.startXY=b.endXY,b.endXY=b.unChangeXY):b.startXY=b.unChangeXY,b.reInitSelections(),b.getSelectionElements(),b.createRects(),b.inserRects()}this.svg=document.getElementsByTagName("svg")[0],this.selectionElements=[],this.rects=[],this.notation.svg=this.svg,this.notation.pages=this.render.pages,this.notation.pageIndex=this.render.displayedPage,this.notation.showNotation(),this.notation.showMark(),this.svg.onmousedown=function(){return!1};var b=this;this.svg.addEventListener("mousedown",function(c){b.svgPosition=EPUB.Utils.offset(b.svg),b.startXY={x:c.pageX,y:c.pageY},b.unChangeXY=b.startXY,b.reInitSelections(),b.svg.addEventListener("mousemove",a,!1)},!1),this.svg.addEventListener("mouseup",function(c){b.svg.removeEventListener("mousemove",a,!1),b.notation.svgSelected=b.selectionElements,b.notation.bacRects=b.rects,b.notation.showPostion={x:c.pageX,y:c.pageY},b.notation.initNotation()})},EPUB.Selections.prototype.reInitSelections=function(){var a=this;this.rects.length>0&&(this.rects.forEach(function(b){a.svg.removeChild(b)}),this.rects=[]),this.selectionElements=[]},EPUB.Selections.prototype.getSelectionElements=function(){var a=Array.prototype.slice.call(document.getElementsByClassName("context")),b=this;a.forEach(function(a){var c=parseInt(a.getAttribute("data-height"),10),d=parseInt(a.getAttribute("y"),10)+parseInt(b.svgPosition.top,10),e=parseInt(a.getAttribute("x"),10)+parseInt(b.svgPosition.left,10);b.endXY.y-b.startXY.y<=c&&b.startXY.x-e<11&&b.endXY.x-e>11&&d>b.startXY.y&&d<=b.endXY.y+c?b.selectionElements.push(a):b.endXY.y-b.startXY.y>c&&(d>b.startXY.y+c&&d<b.endXY.y||d>b.startXY.y&&d<b.startXY.y+c&&b.startXY.x-e<11||d>=b.endXY.y&&d<b.endXY.y+c&&b.endXY.x-e>11)&&b.selectionElements.push(a)})},EPUB.Selections.prototype.createRects=function(){if(this.selectionElements.length>0){var a=this;this.selectionElements.forEach(function(b){if("image"!=b.tagName){var c=document.createElementNS("http://www.w3.org/2000/svg","rect");c.setAttribute("x",b.getAttribute("x")),c.setAttribute("y",b.getAttribute("y")-b.getAttribute("font-size")),c.setAttribute("width",b.getAttribute("data-width")),c.setAttribute("height",b.getAttribute("data-height")),c.setAttribute("fill","yellow"),c.setAttribute("class","svgBackRect"),a.rects.push(c)}})}},EPUB.Selections.prototype.inserRects=function(){if(this.rects.length>0)for(var a=0;a<this.rects.length;a++)this.svg.insertBefore(this.rects[a],this.svg.firstChild)},EPUB.Utils={},EPUB.Utils.parseUrl=function(a){var b,c,d,e={protocol:"",host:"",path:"",origin:"",directory:"",base:"",filename:"",extension:"",fragment:"",href:a},f=a.indexOf("blob:"),g=a.indexOf("://"),h=a.indexOf("?"),i=a.indexOf("#");return 0===f?(e.protocol="blob",e.base=a.indexOf(0,i),e):(-1!=i&&(e.search=a.slice(i+1),e.href=a.slice(0,i)),-1!=h&&(e.search=a.slice(h+1),e.href=a.slice(0,h)),-1!=g?(e.protocol=a.slice(0,g),b=a.slice(g+3),d=b.indexOf("/"),-1===d?(e.host=e.path,e.path=""):(e.host=b.slice(0,d),e.path=b.slice(d)),e.origin=e.protocol+"://"+e.host+"/",e.directory=this.formatFolder(e.path),e.base=e.origin+e.directory):(e.path=a,e.directory=this.formatFolder(a),e.base=e.directory),e.filename=a.replace(e.base,""),c=e.filename.lastIndexOf("."),-1!=c&&(e.extension=e.filename.slice(c+1)),e)},EPUB.Utils.formatFolder=function(a){var b=a.lastIndexOf("/");if(-1==b)var c="";return c=a.slice(0,b+1)},Date.prototype.Format=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a},EPUB.Utils.getCss=function(a,b){return a.currentStyle?a.currentStyle[b]:window.getComputedStyle(a,null)[b]},EPUB.Utils.changeCss=function(a,b,c){var d;document.all?d="rules":document.getElementById&&(d="cssRules");for(var e=0;e<document.styleSheets[0][d].length;e++)document.styleSheets[0][d][e].selectorText==a&&(document.styleSheets[0][d][e].style[b]=c)},EPUB.Utils.offset=function(a){var b,c,d=a,e={top:0,left:0},f=d&&d.ownerDocument;if(f)return b=f.documentElement,this.contains(b,d)?("undefined"!=typeof d.getBoundingClientRect()&&(e=d.getBoundingClientRect()),c=this.getWindow(f),{top:e.top+c.pageYOffset-b.clientTop,left:e.left+c.pageXOffset-b.clientLeft}):e},EPUB.Utils.contains=function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!c.contains(d))},EPUB.Utils.isWindow=function(a){return null!=a&&a===a.window},EPUB.Utils.getWindow=function(a){return this.isWindow(a)?a:9===a.nodeType&&a.defaultView},EPUB.Utils.JsonToFormData=function(a){var b="";for(var c in a)b+=c+"="+a[c]+"&";return b.slice(0,-1)};